name: Build

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
    - uses: actions/checkout@v2
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'adopt'
    - name: Setup Codename One Build Client
      run: |
        mkdir -p ~/.codenameone
        wget https://github.com/codenameone/CodenameOne/raw/refs/heads/master/maven/CodeNameOneBuildClient.jar -O ~/.codenameone/CodeNameOneBuildClient.jar
    - name: Build with Maven
      run: mvn install -DskipTests

  android:
    runs-on: ubuntu-22.04
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Install Java 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'
      - name: Install Android SDK
        uses: android-actions/setup-android@v3
        with:
          packages: platform-tools emulator system-images;android-33;google_apis;x86_64
      - name: Set JAVA17_HOME
        run: echo "JAVA17_HOME=$JAVA_HOME" >> $GITHUB_ENV
      - name: Install Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
      - name: Setup Codename One Build Client
        run: |
          mkdir -p ~/.codenameone
          wget https://github.com/codenameone/CodenameOne/raw/refs/heads/master/maven/CodeNameOneBuildClient.jar -O ~/.codenameone/CodeNameOneBuildClient.jar
      - name: Install Libraries (JDK 11)
        run: mvn install -DskipTests
      - name: Enable KVM
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-kvm libvirt-daemon-system libvirt-clients bridge-utils
          sudo usermod -aG kvm $USER
          sudo udevadm control --reload-rules && sudo udevadm trigger
      - name: Build BTDemo (JDK 17)
        env:
          APP_DIR: BTDemo
          JAVA_HOME: ${{ env.JAVA17_HOME }}
        run: |
          ./scripts/ci/build-thirdparty-app.sh android
      - name: Boot emulator and run smoke test
        env:
          ANDROID_SDK_ROOT: ${{ env.ANDROID_SDK_ROOT }}
          JAVA_HOME: ${{ env.JAVA17_HOME }}
        run: |
          ./scripts/ci/start-android-emulator.sh
          adb install -r BTDemo/target/*-android-device.apk
          adb shell am start -n com.codename1.btle/.BTDemoStub
          adb logcat -d | tail -n 200

  ios:
    runs-on: macos-15
    timeout-minutes: 20
    steps:
      - uses: actions/checkout@v4
      - name: Install Java 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
      - name: Setup Codename One Build Client
        run: |
          mkdir -p ~/.codenameone
          wget https://github.com/codenameone/CodenameOne/raw/refs/heads/master/maven/CodeNameOneBuildClient.jar -O ~/.codenameone/CodeNameOneBuildClient.jar
      - name: Install Libraries (JDK 11)
        run: mvn install -DskipTests
      - name: Build BTDemo Simulator Bundle
        env:
          APP_DIR: BTDemo
          BUILD_TARGET: ios-sim
        run: |
          ./scripts/ci/build-thirdparty-app.sh ios
      - name: Boot simulator, install, and launch
        env:
          APP_BUNDLE: BTDemo/target/ios-sim/BTDemo.app
          BUNDLE_ID: com.codename1.btle
        run: |
          ./scripts/ci/run-ios-simulator.sh
